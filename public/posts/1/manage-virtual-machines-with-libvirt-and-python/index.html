<!doctype html><html lang=en><head><title>Manage libvirt with Python, TLS and SASL :: fooock blog — Random things about blockchain, scraping and virtualization</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="If you don&amp;rsquo;t know what the libvirt is, then the official web page can clarify some things:
 The libvirt project is a toolkit to manage virtualization platforms. It is used by many applications and support multiple hypervisors like KVM, QEMU, Xen, VMWare and others.
 In this post I will show you how to interact with libvirt using Python and the KVM hypervisor, but first things first.
What do you need to start?"><meta name=keywords content="blockchain virtualization scraping ethereum bitcoin solidity kvm qemu"><meta name=robots content="noodp"><link rel=canonical href=https://blog.fooock.com/posts/1/manage-virtual-machines-with-libvirt-and-python/><link rel=stylesheet href=https://blog.fooock.com/assets/style.css><link rel=stylesheet href=https://blog.fooock.com/assets/green.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://blog.fooock.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://blog.fooock.com/img/favicon/green.png><meta name=twitter:card content="summary"><meta name=twitter:title content="Manage libvirt with Python, TLS and SASL :: fooock blog — Random things about blockchain, scraping and virtualization"><meta name=twitter:description content="If you don&amp;rsquo;t know what the libvirt is, then the official web page can clarify some things:
 The libvirt project is a toolkit to manage virtualization platforms. It is used by many applications and support multiple hypervisors like KVM, QEMU, Xen, VMWare and others.
 In this post I will show you how to interact with libvirt using Python and the KVM hypervisor, but first things first.
What do you need to start?"><meta name=twitter:site content="https://blog.fooock.com"><meta name=twitter:creator content="Javi"><meta name=twitter:image content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Manage libvirt with Python, TLS and SASL :: fooock blog — Random things about blockchain, scraping and virtualization"><meta property="og:description" content="If you don&amp;rsquo;t know what the libvirt is, then the official web page can clarify some things:
 The libvirt project is a toolkit to manage virtualization platforms. It is used by many applications and support multiple hypervisors like KVM, QEMU, Xen, VMWare and others.
 In this post I will show you how to interact with libvirt using Python and the KVM hypervisor, but first things first.
What do you need to start?"><meta property="og:url" content="https://blog.fooock.com/posts/1/manage-virtual-machines-with-libvirt-and-python/"><meta property="og:site_name" content="Manage libvirt with Python, TLS and SASL"><meta property="og:image" content><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2019-10-16 19:46:11 &#43;0200 CEST"></head><body><div class="container center"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>fooock blog</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=https://fooock.com>about</a></li><li><a href=https://github.com/fooock/my-blog/issues>report an issue</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=https://fooock.com>about</a></li><li><a href=https://github.com/fooock/my-blog/issues>report an issue</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.fooock.com/posts/1/manage-virtual-machines-with-libvirt-and-python/>Manage libvirt with Python, TLS and SASL</a></h1><div class=post-meta><span class=post-date>2019-10-16</span>
<span class=post-author>::
Javi</span></div><span class=post-tags>#<a href=https://blog.fooock.com/tags/libvirt/>libvirt</a>&nbsp;
#<a href=https://blog.fooock.com/tags/python/>python</a>&nbsp;
#<a href=https://blog.fooock.com/tags/kvm/>kvm</a>&nbsp;
#<a href=https://blog.fooock.com/tags/virtualization/>virtualization</a>&nbsp;</span><div class=post-content><p>If you don&rsquo;t know what the <code>libvirt</code> is, then the <a href=https://libvirt.org/>official</a> web page can clarify some things:</p><blockquote><p>The libvirt project is a toolkit to manage virtualization platforms. It is used by many applications and support multiple hypervisors like <code>KVM</code>, <code>QEMU</code>, <code>Xen</code>, <code>VMWare</code> and <a href=https://libvirt.org/drivers.html>others</a>.</p></blockquote><p>In this post I will show you how to interact with libvirt using Python and the <code>KVM</code> hypervisor, but first things first.</p><h3 id=what-do-you-need-to-start>What do you need to start?</h3><p>If you are in Ubuntu like me, you need to install the <code>libvirt-dev</code> package. Using apt is easy:</p><pre><code>$ sudo apt-get install libvirt-dev
</code></pre><p>Also, you will need <a href=https://www.python.org/>Python</a> and <a href=https://pypi.org/project/pip/>pip</a> installed in your system. We will create a new virtual environment using <code>Python 3.7</code>. For this purpose I use <a href=https://docs.conda.io/en/latest/>Conda</a>. The next command creates a virtual environment called <code>libvirt</code></p><pre><code>$ conda create --name libvirt python=3.7
</code></pre><p>When done, you need to activate this environment using <code>conda activate libvirt</code>. Now, we will proceed to install the <a href=https://pypi.org/project/libvirt-python/>libvirt-python</a> package version <code>5.7.0</code> using pip (at this time, this is the latest release).</p><pre><code>(libvirt) $ pip install libvirt-python==5.7.0
</code></pre><p>If all is ok, then you are ready to go.</p><h3 id=connect-to-the-kvm-hypervisor-driver>Connect to the KVM hypervisor driver</h3><p>As I commented previously, we&rsquo;ll use the <code>KVM</code> hypervisor. As this hypervisor is <code>QEMU</code> compatible, the driver will be <code>qemu:///system</code>. If you want to see other options, see <a href=https://libvirt.org/docs/libvirt-appdev-guide-python/en-US/html/libvirt_application_development_guide_using_python-Connections-URI_Formats.html>this</a>.</p><blockquote><p>Note that this is a privileged URI.</p></blockquote><p>To open a connection to the RPC server exposed by the <em>libvirt daemon</em>, it must be running. You can check it&rsquo;s state using <code>systemctl status libvirtd</code>. In case that the daemon is not available, you will need to start it using <code>systemctl start libvirtd</code>.</p><blockquote><p>For default, this daemon will only be listening for connection on a local UNIX domain socket. As it is only accessible on the local machine, it&rsquo;s <strong>unencrypted</strong>.</p></blockquote><p>There are two types of sockets:</p><ul><li>Full management capabilities, <code>/var/run/libvirt/libvirt-sock</code>.</li><li>Read only operations, <code>/var/run/libvirt/libvirt-sock-ro</code>.</li></ul><p>We will open the full read-write socket.</p><pre><code class=language-python>&gt;&gt;&gt; import libvirt
&gt;&gt;&gt; conn = libvirt.open('qemu:///system')
&gt;&gt;&gt; conn.getVersion()
3001000
</code></pre><p>If you want to use the read only socket, then you need to specify it when <code>open()</code> method is called, or use the short way, calling <code>openReadOnly()</code>:</p><pre><code class=language-python>&gt;&gt;&gt; conn = libvirt.open('qemu:///system?socket=/var/run/libvirt/libvirt-sock-ro')
&gt;&gt;&gt; # Or call, conn = libvirt.openReadOnly('qemu:///system')
&gt;&gt;&gt; conn.getVersion()
3001000
</code></pre><p>When no hostname is provided in the URI, by default it uses <code>unix</code> transport (same reduntant URI is <code>qemu+unix:///system?socket=...</code>).</p><p>These two methods to create a connection are deprecated in favour of the method <code>openAuth(driver, credentials, flags)</code>. Apart from the driver URI, it takes two more arguments, one with a Python list with the client credentials, and a flags parameter to allows the application request a read only or other type of connection.</p><p>I will show you how to configure <code>libvirt</code> with authentication using <a href=https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer><code>SASL</code></a>. There are several points to note:</p><ul><li><code>SASL</code> doesn&rsquo;t require real accounts on the server. It uses its own database to store names and passwords.</li><li>Connections using <code>SASL</code> are encrypted. The current data encryption mechanism in the new versions of <code>libvirt</code> is <code>GSSAPI</code>, but we will use <code>TLS</code>. Since we will use <code>SASL</code> on top of <code>TLS</code>, we can deactivate session encryption to avoid overhead.</li></ul><p>Lets go. First, we need to edit the file <code>/etc/default/libvirtd</code> and add this option to start listening on TCP: <code>libvirtd_opts=&quot;-l&quot;</code></p><blockquote><p>You can use <code>-l</code> or <code>--listen</code></p></blockquote><p>Next, if you restart the <code>libvirtd</code> using <code>systemctl restart libvirtd</code>, it will fail. Why?. Well, by default when this option is enabled, it is necesary to set up a CA and issue server certificates.</p><p>We need to generate server certificates. For this purpose we will use <code>openssl</code>.</p><pre><code class=language-bash>$ # First we create a random passphrase that is written to the passphrase.txt file
$ echo `openssl rand -base64 8` &gt; passphrase.txt
$ # Generate CA certificates
$ openssl genrsa -out cakey.pem -passout file:passphrase.txt 2048
$ openssl req -new -x509 -key cakey.pem -out cacert.pem -passin file:passphrase.txt
$ # Generate new CSR
$ openssl genrsa -out serverkey.pem 2048
$ openssl req -new -key serverkey.pem -out server.csr
$ # Now we create a certificate using the CA
$ openssl x509 -req -in server.csr -CA cacert.pem -CAkey cakey.pem -CAcreateserial -out servercert.pem
</code></pre><p>Now, we need to copy these files to the corresponding folder:</p><ul><li>The <code>cacert.pem</code> certificate will be copied to the <code>/etc/pki/CA/</code> folder.</li><li>The <code>servercert.pem</code> certificate will be copied to the <code>/etc/pki/libvirt/</code> folder.</li><li>The <code>serverkey.pem</code> private key will be copied to the <code>/etc/pki/libvirt/private/</code> folder.</li></ul><blockquote><p>Remember that server certificates must be readable to QEMU processes. Adjust read access to those files.</p></blockquote><p>When done, you need to enable <code>TLS</code> in the <code>/etc/libvirt/libvirtd.conf</code> file. By default, secure TLS connections are enabled by default, but you can add <code>listen_tls = 1</code> to make configuration more readable. Restart <code>libvirtd</code>. Done.</p><p>To test this configuration, you need to create a new certificate for your client, and call one command using <code>TLS</code> transport in the hypervisor driver connection. We will use <code>virsh</code> for this test:</p><pre><code class=language-bash>$ sudo virsh -c qemu+tls://localhost/system list --all
Id   Name   State
--------------------
</code></pre><p>The last step is to configure <code>SASL</code>. We need to add to the file <code>/etc/libvirt/libvirtd.conf</code> this two lines:</p><ul><li><code>auth_tcp = &quot;sasl&quot;</code> to enable <code>SASL</code> for tcp connections.</li><li><code>auth_tls = &quot;sasl&quot;</code> to enable <code>SASL</code> for TLS connections.</li></ul><p>Now we need to configure <code>SASL</code> users. Install the package <code>sasl2-bin</code>, from ubuntu you can:</p><pre><code class=language-bash>$ sudo apt-get install sasl2-bin
</code></pre><p>Add a new user and restart the <code>libvirtd</code>. If you try to execute the last command to list domains in the host, the result will be:</p><pre><code>$ sudo virsh -c qemu+tls://localhost/system list --all
error: failed to connect to the hypervisor
error: authentication failed: authentication failed
</code></pre><p>Create the file <code>auth.conf</code> in <code>/etc/libvirt</code>, and put the user and password created in the last step using <code>saslpasswd2</code>.</p><pre><code class=language-toml>[credentials-sasl]
authname=
password=

[auth-libvirt-localhost]
credentials=sasl
</code></pre><blockquote><p>Remeber restart <code>libvirtd</code>.</p></blockquote><p>We go to write a Python script to test if all works correctly.</p><pre><code class=language-python>import libvirt

SASL_USER = &quot;YOUR_USER&quot;
SASL_PASS = &quot;YOUR_PASSWORD&quot;

def request_cred(credentials, user_data):
  for credential in credentials:
    if credential[0] == libvirt.VIR_CRED_AUTHNAME:
      credential[4] = SASL_USER
    elif credential[0] == libvirt.VIR_CRED_PASSPHRASE:
      credential[4] = SASL_PASS
  return 0

auth = [[libvirt.VIR_CRED_AUTHNAME, libvirt.VIR_CRED_PASSPHRASE], request_cred, None]
conn = libvirt.openAuth('qemu+tls://localhost/system', auth, 0)
print(conn.getVersion())
conn.close()
</code></pre><p>If you execute the script, then:</p><pre><code class=language-bash>(libvirt) $ python virt.py
3001000
</code></pre><p>All works fine!.</p><h3 id=release-resources>Release resources</h3><p>The <code>conn</code> object is of type <code>libvirt.virConnect</code>. All connections should be closed using the <code>close()</code> method:</p><pre><code class=language-python>&gt;&gt;&gt; conn.close()
0
&gt;&gt;&gt; conn.getVersion()
libvirt: Domain Config error : invalid connection pointer in virConnectGetVersion
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;/home/javi/miniconda3/envs/libvirt/lib/python3.7/site-packages/libvirt.py&quot;, line 4016, in getVersion
    if ret == -1: raise libvirtError ('virConnectGetVersion() failed', conn=self)
libvirt.libvirtError: invalid connection pointer in virConnectGetVersion
</code></pre><p>As you can see, after closing the connection, no method calls are allowed.</p><p>Using this connection object you can define new virtual machines, list host domains, filter by name etc, but I will explain it in a new blog posts.</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.fooock.com/posts/hello-world/><span class=button__text>Hello world!</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2019 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://blog.fooock.com/assets/main.js></script><script src=https://blog.fooock.com/assets/prism.js></script></div></body></html>